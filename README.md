# spikeSorter

8/1/2019

This process relays on several steps handled by different scripts:

1. Set experiment information, handled by makeExpermientFile.mat: This first scripts takes the binary data file and some user input to create am experiment.mat file that contains information important to extract spikes form the recording. This file includes information about the probe. Namely, number of channels and an order index for each channel that will arrange them in 1 dimension. This order is important in that it determines which channels neighbor each other which impacts on the effects of artificial refractory periods (see notes on spikesFunction). In addition, the output file of this function includes a threshold for spike detection in each channel (set manually by the user based on first 60sec of recording) and a Boolean array indicating bad channels that should be discarded (also set by the user after being presented first 60s of recording).

2. Detect spikes and extract spike properties, handled by spikesFunction.mat: This function will extract spikes from the raw data using the information provided by experiment.mat. The function does not process the entire data at once. Instead, it will only process a subset of the data (across recording time) based on the JobID input (second input variable of the function). This allows analysis to be done job by job in a single computer that could not load all of the experiment raw data in memory. It also allows for a cluster to run different JobIDs in parallel on different computers to speed up processing time. Spikes are detected on the sample with minimum voltage within .3msec (settings variable thrTime) of crossing threshold. Artificial refractory period is implemented to span a fixed amount of time (refrTime in settins given in msec. applied half before and half after peak) and space (refrSpace in settings given in um). The code considers the geometry of the probe to decide which channels should be influenced by artificial refractory periods triggered by a spike in a given channel based on individual channel distances and it takes into account sampleFrq to restrict the temporal refractory period. Once spikes are detected, spikesFunction will calculate a number of pre-set spike properties including peak-to-peak amplitude across the detected channel and channels neighboring the detected channel, energy, width of depolarization half-maximum etc. This information is saved in an output file called spikesFile. A spikesFile will be created for each JobID and will have to be merged together for a complete list of spikes detected across the entire experiment.

3. Sort spikes, handled by sortGUI: This is the GUI that will implement manual sorting. The feature of this gui that allows for reasonably quick manual sorting is the addition of a spike property named "Position". A spike position is a property computed by spikesFunction that essentially uses the amplitude of a spike in its detected and surrounding channels to assign a position to the spike. It calculates this position by simply computing the center of mass of peak-to-peak amplitude of the spike in different channels. This feature is made much nicer by Isis's update  where spike amplitudes in different channels are assigned a 2-dimensional x-y position given the probe geometry. Therefore, spike position is 2-dimensional allowing for more precise sorting. By projecting spike position vs spike amplitude at detected channel using sortGUi, clusters of spikes with amplitudes that clearly stand out from smaller unsortable spikes can be quickly recognized and sorted along different parts of the probe. By projecting spike position vs amplitude at channels neighboring the detected channel additional clusters may be detected which correspond to spikes that are not big enough to be sorted in the detected channel but stand out by having a larger amplitude on surrounding channels. Clusters of spikes that are first sorted in this way, can be sorted further by comparing spike amplitude across different neighboring channel as one would do when sorting tetrode data. Finally, spikes can be sorted based on shape by using properties such as energy, peak-to-peak amplitude and spike width. This step of the manual sorting is usually useful at cleaning spikes with anomalous shapes that may correspond to noise instead of actual spikes. An additional spike property that user may find useful is the "channel width". This property looks at the amplitude of a spike in its detected channel (where it is the biggest) and divides it by the sum of the amplitude across all channels. Both spikes that only show up in the detected channel (Channel width = 1) on a probe densely packed with recording sites as well as spikes that do not decrease in amplitude as one considers channel far away from the detected channel (Channel width ~0) may represent noise instead of real spikes. SortGUI saves the user sorted data by changing the cluster identity number on the variable idk which is stored in the spikesFile. This data, along with timestamps for the spikes, can then be used to compute single unit responses.

Additional features and possible applications:

Motion detection and correction: The addition of a spike position property in this analysis allows for post-processing analysis of probe movement during the recording session. When visualizing spike position vs spike time using SortGUI, the user can identify a patern of "more populated" and "less populated" areas of the probe where more or less spikes are detected. If the probe moves during the recording, sites that were positioned on more populated areas of cortex (where more spikes occur) sill shift to surrounding areas that are less populated. This can be observed using sortGUI when plotting spike position vs spike time as the profile of spikes density along the probe shifts as time increases. This can be differentiates from changes in overall activity levels due to brain state changes where the overall density of spikes may quickly change along the entire probe without any obvious shift of the spatial arrangement of spikes density. In recordings where slow probe motion occurred (1-3 channels across the entire session) it would be possible to analyze the shift in the spikes density profile along the probe to and use it to correct the spike position for spikes detected at different times to correct for this displacement. While this motion will still make it impossible to sort spikes based on modes differences in amplitudes on different channels (because this is constantly changing due to motion), large spikes that can be reliably sorted based on amplitude in a single channel across the experiment may be recovered by correcting the effect of probe displacement. That said, my personal advice is to discard any recording that shows significant signs of displacement.

Before running sorting code in a new PC:
1. Modify settings file. There are 2 directory locations: one where the experiment data is stored (expFolder) and one where the spikes files will be saved (spikesFolder). These need to be changed in every computer. In addition, settings includes some variables that are important for analysis. sampleFrq: this is a default sample frequency that the program will assume unless a new value is given by experiment.mat. lowPass/highPass: the cut-off frequencies for the band-pass filter step applied to raw data before threshold setting and spike detection. refrTime and refrSpace give the time and space boundary of the refractory period implementation (1.2ms, which means .6msec before and after, and 100um by default). thrTime: time after threshold crossing to allow for spike detection in msec (.3msec). wvfTime: waveforms will be calculated for spikes from half this time before peak to this time after peak (1msec).
2. If using probes that are not listed in probeConfigurations.mat then add this probe arrangements before running the code. The information about the new probe must be added in a new field to the configs structure that is named probe_XXXX where XXXX is the probe name. Inside this new field an nx4 table must be created where n is the number of recording sites. The first column of this table given a number to each channel. This ordering must reflect the order of the channels as they are recorded in the raw data. If probe information from the probe provider has one indexing and the recorded data is in an order that is different from that then this column can be used to match one indexing with the other. This happens with UCLA probes which are numbered in a certain way by Masmanidis lab and recorded in a different order by Intan hardware. The second and third columns are the X and Y positions (in um) for each site ([0,0] is the position of most upper-left recording site). Fourth column has the shank number to which each site belongs to (mostly used for visualization in sortGUI and limits the application of artificial refractory periods in Isis code). 
3. If using a system other than Intan modify code on getSampleFreqFromInfoFile.mat and getRawDataFromDile.mat. The first function should get one input variable with the name of the file where the sample frequency is stored and return this sample frequency (in samples/sec). The second should get one input variable with the name of the file and return an nxt array of samples with n being number of recording sites and t number of samples. Filenames for these two functions mas be named after the “experiment name” with some addition at the end (such as ‘_amplidier.dat’ for Intan raw data and ‘_info.rhd’ for intan info file). 

Steps to sort spikes:
1. Copy your data folder into your experiment folder: 
Save your data in the path specify by expFolder in settings.mat. The folder where your data is has to be named as your “experiment name”. Same goes for the raw data and info files inside that folder.

2. Make experiment mat file: This file is made by "makeExperimentFile.m". This script needs manual input of experiment name and probe class. It then presents the first minute of recording to the user for it to decide the threshold for spike detection and indicate which channels are bad. This file will contain information about the experiment required to process the experiment in the cluster.  It contains: 
   - a1 and b1: Bandpass filter to filter raw data. 
   - BadCh: a boolean vector indicating whether a channel is bad or not.
   - CHs: The order of the channels in the probe, it is decided based on the probe following some track starting from the base to the tip of the probe.
   - experiment: the experiment name.
   - Th: unique threshold to detect spikes on any channel that is not bad.

3. Detect spikes and calculate spikes properties: This is handled by spikesfunction. This function gets 3 inputs: experiment (name of experiment), parts (in how many parts the experiment will be split for analysis), JobID (which part to analyze, first part is indexed as 0, to analyze all the experiment JobIDs from 0 to parts-1 need to be run). This function will make a Spikes_JobID file in a new directory called SpikeFiles (created by makeExperimenFile.m) in your experiment folder. 
5. Merge spikes files: These files contain the spike information for spikes detected in each fraction of the recording. This files are merged in a unique spikes file using script "mergeSpikesFiles". The merged file will include a matrix call "Properties" a vector called "idk" and a cell called "PropTitles". The "Properties" vector includes a number of properties for each detected spike. The spike waveforms are not handled by the spike detection algorithm as the files would be to heavy and hard to work with.  The cell PropTitles indicate which property is included in the Properties matrix. These may be edited but at the moment they include: 
   - Amp(0): amplitude (minimum value minus maximum after this minimum. i.e. peak to peak amplitude) at the channel of detection (the one with the largest negative peak).
   - Amp(-4 to 4): value at peakSample (detected minimum of spike in detected channel) minus maximum after this sample (peak to peak amplitude) for those channels neighboring the channel of detection (4 channels up-left to 4 channels down-right). Channels are sorted from up left to bottom right. When a spike is detected at the end of a probe and a channel in some direction does not exist, that amplitude is set to 0.
   - Hyperpol Peak: Amplitude at detection channel given as minimum minus baseline (before begative peak). 
- Energy: Energy of the spike waveform at the channel of detection.
   - Wvf width: Width of waveform at the channel of detection, post valley position is determined as the first local maxima after sample peakSample (where the minimum is).
   - CHs Width: Calculated as Amp(0) divided by sum of all Amps. Gives a metric of how wide is the spike across channels of the probe.
   - CH Pos: The position of the spike across the probe measured as the center of mass of the spike across channels -1 to 1 (detected +/- 1). This gives center of mass in one dimension which is the order of channels from up-left to down-right.
   - x_cm/y_cm: Center of mas on x/y dimension given spike amplitudes (peak to peak) on all surrounding channels.
   - x/y_detected: X and Y position of channel where spike was detected.
   - Timestamp: sample of detection.
   - CH detected: The channel were the spike was detected (largest negative peak).
   - Shank: the shank to witch the channel where spike was detected belongs. 
Finally, idk is a vector of length = number of detected spikes that is initialized as all zeros. This will later indicate cluster number when sorting.

6. Sort your spikes using "sortGUI" which essentially makes changes to "idk" in spikes file.
